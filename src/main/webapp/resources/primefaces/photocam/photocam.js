var Webcam={version:"1.0.0",protocol:location.protocol.match(/https/i)?"https":"http",swfURL:"",loaded:false,live:false,userMedia:true,params:{width:0,height:0,dest_width:0,dest_height:0,image_format:"jpeg",jpeg_quality:90,force_flash:false},hooks:{load:null,live:null,uploadcomplete:null,uploadprogress:null,error:function(a){alert("Webcam.js Error: "+a)}},init:function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL;this.userMedia=this.userMedia&&!!navigator.getUserMedia&&!!window.URL;if(navigator.userAgent.match(/Firefox\D+(\d+)/)){if(parseInt(RegExp.$1,10)<21){this.userMedia=null}}},attach:function(c){if(typeof(c)=="string"){c=document.getElementById(c)||document.querySelector(c)}if(!c){return this.dispatch("error","Could not locate DOM element to attach to.")}this.container=c;c.innerHTML="";var e=document.createElement("div");c.appendChild(e);this.peg=e;if(!this.params.width){this.params.width=c.offsetWidth}if(!this.params.height){this.params.height=c.offsetHeight}if(!this.params.dest_width){this.params.dest_width=this.params.width}if(!this.params.dest_height){this.params.dest_height=this.params.height}if(this.params.force_flash){this.userMedia=null}var h=this.params.width/this.params.dest_width;var g=this.params.height/this.params.dest_height;if(this.userMedia){var b=document.createElement("video");b.setAttribute("autoplay","autoplay");b.style.width=""+this.params.dest_width+"px";b.style.height=""+this.params.dest_height+"px";if((h!=1)||(g!=1)){c.style.overflow="hidden";b.style.webkitTransformOrigin="0px 0px";b.style.mozTransformOrigin="0px 0px";b.style.msTransformOrigin="0px 0px";b.style.oTransformOrigin="0px 0px";b.style.transformOrigin="0px 0px";b.style.webkitTransform="scaleX("+h+") scaleY("+g+")";b.style.mozTransform="scaleX("+h+") scaleY("+g+")";b.style.msTransform="scaleX("+h+") scaleY("+g+")";b.style.oTransform="scaleX("+h+") scaleY("+g+")";b.style.transform="scaleX("+h+") scaleY("+g+")"}c.appendChild(b);this.video=b;var i=this;navigator.getUserMedia({audio:false,video:true},function(j){b.src=window.URL.createObjectURL(j)||j;Webcam.stream=j;Webcam.loaded=true;Webcam.live=true;Webcam.dispatch("load");Webcam.dispatch("live")},function(j){return i.dispatch("error","Could not access webcam.")})}else{var a=document.createElement("div");a.innerHTML=this.getSWFHTML();c.appendChild(a)}if(this.params.crop_width&&this.params.crop_height){var f=Math.floor(this.params.crop_width*h);var d=Math.floor(this.params.crop_height*g);c.style.width=""+f+"px";c.style.height=""+d+"px";c.style.overflow="hidden";c.scrollLeft=Math.floor((this.params.width/2)-(f/2));c.scrollTop=Math.floor((this.params.height/2)-(d/2))}else{c.style.width=""+this.params.width+"px";c.style.height=""+this.params.height+"px"}},reset:function(){if(this.userMedia){try{this.stream.stop()}catch(a){}delete this.stream;delete this.video}this.container.innerHTML="";delete this.container;this.loaded=false;this.live=false},set:function(){if(arguments.length==1){for(var a in arguments[0]){this.params[a]=arguments[0][a]}}else{this.params[arguments[0]]=arguments[1]}},on:function(a,b){a=a.replace(/^on/i,"").toLowerCase();if(typeof(this.hooks[a])=="undefined"){throw"Event type not supported: "+a}this.hooks[a]=b},dispatch:function(){var b=arguments[0].replace(/^on/i,"").toLowerCase();var a=Array.prototype.slice.call(arguments,1);if(this.hooks[b]){if(typeof(this.hooks[b])=="function"){this.hooks[b].apply(this,a)}else{if(typeof(this.hooks[b])=="array"){this.hooks[b][0][this.hooks[b][1]].apply(this.hooks[b][0],a)}else{if(window[this.hooks[b]]){window[this.hooks[b]].apply(window,a)}}}return true}return false},setSWFLocation:function(a){this.swfURL=a},getSWFHTML:function(){var e="";if(location.protocol.match(/file/)){return'<h1 style="color:red">Sorry, the Webcam.js Flash fallback does not work from local disk.  Please upload it to a web server first.</h1>'}if(!this.swfURL){var h="";var f=document.getElementsByTagName("script");for(var b=0,a=f.length;b<a;b++){var g=f[b].getAttribute("src");if(g&&g.match(/\/webcam(\.min)?\.js/)){h=g.replace(/\/webcam(\.min)?\.js.*$/,"");b=a}}if(h){this.swfURL=h+"/webcam.swf"}else{this.swfURL="webcam.swf"}}if(window.localStorage&&!localStorage.getItem("visited")){this.params.new_user=1;localStorage.setItem("visited",1)}var c="";for(var d in this.params){if(c){c+="&"}c+=d+"="+escape(this.params[d])}e+='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" type="application/x-shockwave-flash" codebase="'+this.protocol+'://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="'+this.params.width+'" height="'+this.params.height+'" id="webcam_movie_obj" align="middle"><param name="wmode" value="opaque" /><param name="allowScriptAccess" value="always" /><param name="allowFullScreen" value="false" /><param name="movie" value="'+this.swfURL+'" /><param name="loop" value="false" /><param name="menu" value="false" /><param name="quality" value="best" /><param name="bgcolor" value="#ffffff" /><param name="flashvars" value="'+c+'"/><embed id="webcam_movie_embed" src="'+this.swfURL+'" wmode="opaque" loop="false" menu="false" quality="best" bgcolor="#ffffff" width="'+this.params.width+'" height="'+this.params.height+'" name="webcam_movie_embed" align="middle" allowScriptAccess="always" allowFullScreen="false" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="'+c+'"></embed></object>';return e},getMovie:function(){if(!this.loaded){return this.dispatch("error","Flash Movie is not loaded yet")}var a=document.getElementById("webcam_movie_obj");if(!a||!a._snap){a=document.getElementById("webcam_movie_embed")}if(!a){this.dispatch("error","Cannot locate Flash movie in DOM")}return a},freeze:function(){var b=this;var h=this.params;if(this.preview_active){this.unfreeze()}var d=this.params.width/this.params.dest_width;var a=this.params.height/this.params.dest_height;var c=h.crop_width||h.dest_width;var g=h.crop_height||h.dest_height;var f=document.createElement("canvas");f.width=c;f.height=g;var e=f.getContext("2d");this.preview_canvas=f;this.preview_context=e;if((d!=1)||(a!=1)){f.style.webkitTransformOrigin="0px 0px";f.style.mozTransformOrigin="0px 0px";f.style.msTransformOrigin="0px 0px";f.style.oTransformOrigin="0px 0px";f.style.transformOrigin="0px 0px";f.style.webkitTransform="scaleX("+d+") scaleY("+a+")";f.style.mozTransform="scaleX("+d+") scaleY("+a+")";f.style.msTransform="scaleX("+d+") scaleY("+a+")";f.style.oTransform="scaleX("+d+") scaleY("+a+")";f.style.transform="scaleX("+d+") scaleY("+a+")"}this.snap(function(){f.style.position="relative";f.style.left=""+b.container.scrollLeft+"px";f.style.top=""+b.container.scrollTop+"px";b.container.insertBefore(f,b.peg);b.container.style.overflow="hidden";b.preview_active=true},f)},unfreeze:function(){if(this.preview_active){this.container.removeChild(this.preview_canvas);delete this.preview_context;delete this.preview_canvas;this.preview_active=false}},savePreview:function(e,d){var f=this.params;var b=this.preview_canvas;var c=this.preview_context;if(d){var a=d.getContext("2d");a.drawImage(b,0,0)}e(d?null:b.toDataURL("image/"+f.image_format,f.jpeg_quality/100),b,c);this.unfreeze()},snap:function(i,f){var h=this;var d=this.params;if(!this.loaded){return this.dispatch("error","Webcam is not loaded yet")}if(!this.live){return this.dispatch("error","Webcam is not live yet")}if(!i){return this.dispatch("error","Please provide a callback function or canvas to snap()")}if(this.preview_active){this.savePreview(i,f);return null}var b=document.createElement("canvas");b.width=this.params.dest_width;b.height=this.params.dest_height;var a=b.getContext("2d");var c=function(){if(this.src&&this.width&&this.height){a.drawImage(this,0,0,d.dest_width,d.dest_height)}if(d.crop_width&&d.crop_height){var k=document.createElement("canvas");k.width=d.crop_width;k.height=d.crop_height;var l=k.getContext("2d");l.drawImage(b,Math.floor((d.dest_width/2)-(d.crop_width/2)),Math.floor((d.dest_height/2)-(d.crop_height/2)),d.crop_width,d.crop_height,0,0,d.crop_width,d.crop_height);a=l;b=k}if(f){var j=f.getContext("2d");j.drawImage(b,0,0)}i(f?null:b.toDataURL("image/"+d.image_format,d.jpeg_quality/100),b,a)};if(this.userMedia){a.drawImage(this.video,0,0,this.params.dest_width,this.params.dest_height);c()}else{var g=this.getMovie()._snap();var e=new Image();e.onload=c;e.src="data:image/"+this.params.image_format+";base64,"+g}return null},configure:function(a){if(!a){a="camera"}this.getMovie()._configure(a)},flashNotify:function(a,b){switch(a){case"flashLoadComplete":this.loaded=true;this.dispatch("load");break;case"cameraLive":this.live=true;this.dispatch("live");break;case"error":this.dispatch("error",b);break;default:break}},b64ToUint6:function(a){return a>64&&a<91?a-65:a>96&&a<123?a-71:a>47&&a<58?a+4:a===43?62:a===47?63:0},base64DecToArr:function(b,k){var j=b.replace(/[^A-Za-z0-9\+\/]/g,""),d=j.length,a=k?Math.ceil((d*3+1>>2)/k)*k:d*3+1>>2,h=new Uint8Array(a);for(var g,f,e=0,c=0,i=0;i<d;i++){f=i&3;e|=this.b64ToUint6(j.charCodeAt(i))<<18-6*f;if(f===3||d-i===1){for(g=0;g<3&&c<a;g++,c++){h[c]=e>>>(16>>>g&24)&255}e=0}}return h},upload:function(f,c,i){if(i){Webcam.on("uploadComplete",i)}var d="webcam";var g="";if(f.match(/^data\:image\/(\w+)/)){g=RegExp.$1}else{throw"Cannot locate image format in Data URI"}var e=f.replace(/^data\:image\/\w+\;base64\,/,"");var h=new XMLHttpRequest();h.open("POST",c,true);if(h.upload&&h.upload.addEventListener){h.upload.addEventListener("progress",function(k){if(k.lengthComputable){var j=k.loaded/k.total;Webcam.dispatch("uploadProgress",j,k)}},false)}h.onload=function(){Webcam.dispatch("uploadComplete",h.status,h.responseText,h.statusText)};var a=new Blob([this.base64DecToArr(e)],{type:"image/"+g});var b=new FormData();b.append(d,a,d+"."+g.replace(/e/,""));h.send(b)}};Webcam.init();PrimeFaces.widget.PhotoCam=PrimeFaces.widget.BaseWidget.extend({init:function(a){this._super(a);this.cfg.width=this.cfg.width||320;this.cfg.height=this.cfg.height||240;this.cfg.photoWidth=this.cfg.photoWidth||this.cfg.width;this.cfg.photoHeight=this.cfg.photoHeight||this.cfg.height;this.cfg.jpegQuality=this.cfg.jpegQuality||90;Webcam.setSWFLocation(this.cfg.camera);Webcam.set({width:this.cfg.width,height:this.cfg.height,dest_width:this.cfg.photoWidth,dest_height:this.cfg.photoHeight,image_format:this.cfg.format,jpeg_quality:this.cfg.jpegQuality,force_flash:this.cfg.forceFlash});Webcam.attach(this.id)},capture:function(){var a=this;Webcam.snap(function(c){var b={source:a.id,process:a.cfg.process?a.id+" "+a.cfg.process:a.id,update:a.cfg.update,params:[{name:a.id+"_data",value:c}]};PrimeFaces.ajax.Request.handle(b)})}});